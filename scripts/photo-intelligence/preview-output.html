<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photo Intelligence Pipeline - Output Preview</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      h1 {
        color: #fff;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #888;
        margin-bottom: 30px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .stat-card {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #333;
      }
      .stat-card h3 {
        color: #888;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 10px;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #4a9eff;
      }
      .section {
        background: #2a2a2a;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #333;
      }
      .section h2 {
        color: #fff;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4a9eff;
      }
      .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .photo-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }
      .photo-info {
        padding: 15px;
      }
      .photo-info h3 {
        color: #fff;
        font-size: 14px;
        margin-bottom: 10px;
        word-break: break-all;
      }
      .photo-meta {
        font-size: 12px;
        color: #888;
        margin-bottom: 5px;
      }
      .crop-preview {
        position: relative;
        width: 100%;
        height: 200px;
        background: #0a0a0a;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #444;
        font-size: 12px;
      }
      .crop-box {
        position: absolute;
        border: 2px solid #4a9eff;
        background: rgba(74, 158, 255, 0.1);
        pointer-events: none;
      }
      .crop-label {
        position: absolute;
        top: -20px;
        left: 0;
        font-size: 10px;
        color: #4a9eff;
        background: #1a1a1a;
        padding: 2px 6px;
        border-radius: 3px;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        margin-right: 5px;
        margin-top: 5px;
      }
      .badge.faces {
        background: #4a9eff;
        color: #fff;
      }
      .badge.persons {
        background: #ff6b6b;
        color: #fff;
      }
      .badge.crops {
        background: #51cf66;
        color: #fff;
      }
      .cluster-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .cluster-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
      }
      .cluster-card h4 {
        color: #fff;
        margin-bottom: 10px;
      }
      .cluster-photos {
        font-size: 12px;
        color: #888;
      }
      .error {
        color: #ff6b6b;
        padding: 20px;
        background: #2a1a1a;
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #888;
      }
      .file-input {
        margin-bottom: 20px;
      }
      .file-input label {
        display: inline-block;
        padding: 10px 20px;
        background: #4a9eff;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
      .file-input input {
        display: none;
      }
      .file-path {
        margin-top: 10px;
        font-size: 12px;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Photo Intelligence Pipeline - Output Preview</h1>
      <p class="subtitle">
        Visualize pipeline results: crops, clusters, and detections
      </p>

      <div class="file-input">
        <label for="photosFile">Load photos.json</label>
        <input type="file" id="photosFile" accept=".json" />
        <div class="file-path" id="photosPath"></div>
      </div>

      <div class="file-input">
        <label for="clustersFile">Load clusters.json</label>
        <input type="file" id="clustersFile" accept=".json" />
        <div class="file-path" id="clustersPath"></div>
      </div>

      <div class="file-input">
        <label for="photosDir"
          >Select Photos Directory (for image preview)</label
        >
        <input type="file" id="photosDir" webkitdirectory directory multiple />
        <div class="file-path" id="photosDirPath"></div>
        <small style="color: #888; display: block; margin-top: 5px">
          Select the directory containing the photos (e.g., /Volumes/Extreme
          SSD/Photos)
        </small>
      </div>

      <div id="error" class="error" style="display: none"></div>
      <div id="loading" class="loading" style="display: none">
        Loading data...
      </div>

      <div id="content" style="display: none">
        <!-- Stats Section -->
        <div class="section">
          <h2>Statistics</h2>
          <div class="stats" id="stats"></div>
        </div>

        <!-- Sample Photos Section -->
        <div class="section">
          <h2>Sample Photos (First 20)</h2>
          <div class="photo-grid" id="photoGrid"></div>
        </div>

        <!-- Clusters Section -->
        <div class="section">
          <h2>Clusters</h2>
          <div id="clustersContent"></div>
        </div>
      </div>
    </div>

    <script>
      let photosData = null
      let clustersData = null
      let photoFileMap = new Map() // Maps filename -> File object

      function showError(message) {
        const errorDiv = document.getElementById('error')
        errorDiv.textContent = message
        errorDiv.style.display = 'block'
      }

      function hideError() {
        document.getElementById('error').style.display = 'none'
      }

      function showLoading() {
        document.getElementById('loading').style.display = 'block'
        document.getElementById('content').style.display = 'none'
      }

      function hideLoading() {
        document.getElementById('loading').style.display = 'none'
        document.getElementById('content').style.display = 'block'
      }

      function loadJSON(file, callback) {
        const reader = new FileReader()
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result)
            callback(data)
          } catch (err) {
            showError(`Error parsing JSON: ${err.message}`)
          }
        }
        reader.onerror = () => showError('Error reading file')
        reader.readAsText(file)
      }

      function updateStats() {
        if (!photosData) return

        const stats = {
          totalPhotos: photosData.length,
          photosWithFaces: photosData.filter(
            (p) => p.faces && p.faces.length > 0
          ).length,
          photosWithPersons: photosData.filter(
            (p) => p.persons && p.persons.length > 0
          ).length,
          photosWithCrops: photosData.filter(
            (p) => p.crops && Object.keys(p.crops).length > 0
          ).length,
          totalFaces: photosData.reduce(
            (sum, p) => sum + (p.faces?.length || 0),
            0
          ),
          totalPersons: photosData.reduce(
            (sum, p) => sum + (p.persons?.length || 0),
            0
          ),
          totalCrops: photosData.reduce(
            (sum, p) => sum + (p.crops ? Object.keys(p.crops).length : 0),
            0
          ),
        }

        if (clustersData) {
          stats.nearDuplicateClusters =
            clustersData.near_duplicates?.length || 0
          stats.sceneClusters = clustersData.scenes?.length || 0
          stats.peopleClusters = clustersData.people?.length || 0
        }

        const statsHtml = Object.entries(stats)
          .map(([key, value]) => {
            const label = key
              .replace(/([A-Z])/g, ' $1')
              .replace(/^./, (str) => str.toUpperCase())
            return `
                    <div class="stat-card">
                        <h3>${label}</h3>
                        <div class="value">${value.toLocaleString()}</div>
                    </div>
                `
          })
          .join('')

        document.getElementById('stats').innerHTML = statsHtml
      }

      function renderPhotoCard(photo) {
        const hasFaces = photo.faces && photo.faces.length > 0
        const hasPersons = photo.persons && photo.persons.length > 0
        const cropCount = photo.crops ? Object.keys(photo.crops).length : 0

        // Get image file if available (try exact match, then case-insensitive)
        let imageFile = photoFileMap.get(photo.filename)
        if (!imageFile) {
          imageFile = photoFileMap.get(photo.filename.toLowerCase())
        }
        const imageUrl = imageFile ? URL.createObjectURL(imageFile) : null

        // Debug missing images
        if (!imageUrl && photoFileMap.size > 0) {
          console.log(
            `Image not found for: ${photo.filename} (available: ${Array.from(photoFileMap.keys()).slice(0, 3).join(', ')}...)`
          )
        }

        // Create crop preview with actual image or placeholder
        const cropBoxes = []
        let previewContent = ''

        if (photo.crops && photo.width && photo.height) {
          const previewWidth = 300
          const previewHeight = 300
          const scaleX = previewWidth / photo.width
          const scaleY = previewHeight / photo.height
          const scale = Math.min(scaleX, scaleY)
          const scaledWidth = photo.width * scale
          const scaledHeight = photo.height * scale
          const offsetX = (previewWidth - scaledWidth) / 2
          const offsetY = (previewHeight - scaledHeight) / 2

          Object.entries(photo.crops).forEach(([aspect, crop]) => {
            if (crop.crop_box) {
              const x = offsetX + crop.crop_box.x * scale
              const y = offsetY + crop.crop_box.y * scale
              const w = crop.crop_box.width * scale
              const h = crop.crop_box.height * scale
              cropBoxes.push({ aspect, x, y, w, h, method: crop.method })
            }
          })

          previewContent = `
                    <div class="crop-preview-container" style="position: relative; width: ${previewWidth}px; height: ${previewHeight}px; margin: 0 auto; background: #111; border: 1px solid #333;">
                        ${
                          imageUrl
                            ? `
                            <img src="${imageUrl}" 
                                 style="position: absolute; left: ${offsetX}px; top: ${offsetY}px; width: ${scaledWidth}px; height: ${scaledHeight}px; object-fit: contain;"
                                 alt="${photo.filename}">
                        `
                            : `
                            <div style="position: absolute; left: ${offsetX}px; top: ${offsetY}px; width: ${scaledWidth}px; height: ${scaledHeight}px; background: #222; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px;">
                                ${photo.width} × ${photo.height}
                            </div>
                        `
                        }
                        ${cropBoxes
                          .map(
                            (crop) => `
                            <div class="crop-box" style="left: ${crop.x}px; top: ${crop.y}px; width: ${crop.w}px; height: ${crop.h}px; border: 2px solid ${getCropColor(crop.aspect)};">
                                <div class="crop-label">${crop.aspect} (${crop.method})</div>
                            </div>
                        `
                          )
                          .join('')}
                    </div>
                `
        } else {
          previewContent =
            '<div style="color: #444; padding: 20px; text-align: center;">No crops available</div>'
        }

        return `
                <div class="photo-card">
                    ${previewContent}
                    <div class="photo-info">
                        <h3>${photo.filename}</h3>
                        <div class="photo-meta">Dimensions: ${photo.width} × ${photo.height}</div>
                        ${hasFaces ? `<span class="badge faces">${photo.faces.length} Face(s)</span>` : ''}
                        ${hasPersons ? `<span class="badge persons">${photo.persons.length} Person(s)</span>` : ''}
                        ${cropCount > 0 ? `<span class="badge crops">${cropCount} Crop(s)</span>` : ''}
                        ${photo.hashes?.phash ? `<div class="photo-meta">pHash: ${photo.hashes.phash.substring(0, 16)}...</div>` : ''}
                        ${photo.image_embedding ? `<div class="photo-meta">Embedding: ${photo.image_embedding.length}D</div>` : ''}
                    </div>
                </div>
            `
      }

      function getCropColor(aspect) {
        const colors = {
          '4:5': '#ff6b6b',
          '16:9': '#4ecdc4',
          '1:1': '#ffe66d',
          '9:16': '#a8e6cf',
        }
        return colors[aspect] || '#fff'
      }

      function renderClusters() {
        if (!clustersData) {
          document.getElementById('clustersContent').innerHTML =
            '<p style="color: #888;">Load clusters.json to see cluster data</p>'
          return
        }

        let html = ''

        if (
          clustersData.near_duplicates &&
          clustersData.near_duplicates.length > 0
        ) {
          html +=
            '<h3 style="color: #fff; margin-top: 20px; margin-bottom: 15px;">Near Duplicate Clusters</h3>'
          html += '<div class="cluster-list">'
          clustersData.near_duplicates.slice(0, 10).forEach((cluster) => {
            html += `
                        <div class="cluster-card">
                            <h4>Cluster ${cluster.cluster_id}</h4>
                            <div class="cluster-photos">${cluster.photo_filenames.length} photos</div>
                            <div class="cluster-photos" style="margin-top: 5px; font-size: 10px; color: #666;">
                                ${cluster.photo_filenames.slice(0, 3).join(', ')}${cluster.photo_filenames.length > 3 ? '...' : ''}
                            </div>
                        </div>
                    `
          })
          html += '</div>'
        }

        if (clustersData.scenes && clustersData.scenes.length > 0) {
          html +=
            '<h3 style="color: #fff; margin-top: 30px; margin-bottom: 15px;">Scene Clusters</h3>'
          html += '<div class="cluster-list">'
          clustersData.scenes.slice(0, 10).forEach((cluster) => {
            html += `
                        <div class="cluster-card">
                            <h4>Cluster ${cluster.cluster_id}</h4>
                            <div class="cluster-photos">${cluster.photo_filenames.length} photos</div>
                            <div class="cluster-photos" style="margin-top: 5px; font-size: 10px; color: #666;">
                                ${cluster.photo_filenames.slice(0, 3).join(', ')}${cluster.photo_filenames.length > 3 ? '...' : ''}
                            </div>
                        </div>
                    `
          })
          html += '</div>'
        }

        if (clustersData.people && clustersData.people.length > 0) {
          html +=
            '<h3 style="color: #fff; margin-top: 30px; margin-bottom: 15px;">People Clusters</h3>'
          html += '<div class="cluster-list">'
          clustersData.people.slice(0, 10).forEach((cluster) => {
            html += `
                        <div class="cluster-card">
                            <h4>Person ${cluster.person_id}</h4>
                            <div class="cluster-photos">${cluster.photo_filenames.length} photos</div>
                            ${cluster.representative_face ? `<div class="cluster-photos" style="margin-top: 5px; font-size: 10px; color: #666;">Quality: ${cluster.representative_face.quality_score?.toFixed(2) || 'N/A'}</div>` : ''}
                        </div>
                    `
          })
          html += '</div>'
        } else {
          html +=
            '<p style="color: #888; margin-top: 20px;">No people clusters found</p>'
        }

        document.getElementById('clustersContent').innerHTML = html
      }

      function updateDisplay() {
        if (!photosData) return

        hideError()
        hideLoading()

        updateStats()

        // Render sample photos
        const samplePhotos = photosData.slice(0, 20)
        document.getElementById('photoGrid').innerHTML = samplePhotos
          .map(renderPhotoCard)
          .join('')

        renderClusters()
      }

      // File input handlers
      document.getElementById('photosFile').addEventListener('change', (e) => {
        const file = e.target.files[0]
        if (file) {
          document.getElementById('photosPath').textContent =
            `Loaded: ${file.name}`
          showLoading()
          loadJSON(file, (data) => {
            photosData = data
            updateDisplay()
          })
        }
      })

      document
        .getElementById('clustersFile')
        .addEventListener('change', (e) => {
          const file = e.target.files[0]
          if (file) {
            document.getElementById('clustersPath').textContent =
              `Loaded: ${file.name}`
            loadJSON(file, (data) => {
              clustersData = data
              updateDisplay()
            })
          }
        })

      document.getElementById('photosDir').addEventListener('change', (e) => {
        const files = Array.from(e.target.files)
        photoFileMap.clear()

        // Build map of filename -> File (case-insensitive matching)
        files.forEach((file) => {
          const filename = file.name
          // Store with both original and lowercase for matching
          photoFileMap.set(filename, file)
          photoFileMap.set(filename.toLowerCase(), file)
        })

        document.getElementById('photosDirPath').textContent =
          `Loaded ${files.length} image files`

        // Debug: show first few filenames
        if (files.length > 0) {
          console.log(
            'Sample filenames loaded:',
            files.slice(0, 5).map((f) => f.name)
          )
        }

        // Re-render if photos data is already loaded
        if (photosData) {
          updateDisplay()
        }
      })

      // Try to auto-load if files are in same directory
      window.addEventListener('load', () => {
        // Note: Browser security prevents direct file access, so user must select files
        console.log('Ready to load photos.json and clusters.json files')
      })
    </script>
  </body>
</html>
